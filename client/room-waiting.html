<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè† Î£∏ ÎåÄÍ∏∞Ïã§ - Sensor Game Hub v5.0</title>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --background: #0f172a;
            --surface: #1e293b;
            --card: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border: #475569;
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Ìó§Îçî */
        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .back-button {
            background: var(--primary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }
        
        .back-button:hover {
            background: var(--secondary);
            transform: scale(1.1);
        }
        
        .room-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.9rem;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background: var(--card);
            border: 1px solid var(--border);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--error);
            animation: pulse 2s infinite;
        }
        
        .status-connected .status-dot {
            background: var(--success);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑà */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Î£∏ Ï†ïÎ≥¥ ÏÑπÏÖò */
        .room-info {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .room-id-display {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            letter-spacing: 0.3rem;
            color: var(--primary);
            margin: 1rem 0;
        }
        
        .room-game-info {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }
        
        .room-state-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.9rem;
            font-weight: 600;
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .room-state-badge.ready {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border-color: rgba(16, 185, 129, 0.3);
        }
        
        /* ÌîåÎ†àÏù¥Ïñ¥ Î™©Î°ù ÏÑπÏÖò */
        .players-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .player-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .player-card.host {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .player-card.ready {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .player-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .player-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .host-badge {
            background: var(--gradient);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .sensor-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .sensor-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--error);
        }
        
        .sensor-icon.connected {
            background: var(--success);
        }
        
        .sensor-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .sensor-text.connected {
            color: var(--success);
        }
        
        /* Ïª®Ìä∏Î°§ ÏÑπÏÖò */
        .controls-section {
            text-align: center;
        }
        
        .button-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: var(--gradient);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-secondary {
            background: var(--card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover:not(:disabled) {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .btn-danger {
            background: var(--error);
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }
        
        /* ÏÉÅÌÉú Î©îÏãúÏßÄ */
        .status-message {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 500;
        }
        
        .status-message.info {
            background: rgba(59, 130, 246, 0.2);
            color: var(--primary);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .status-message.success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .status-message.warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .status-message.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        /* Î°úÎî© Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: currentColor;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Ïà®ÍπÄ ÌÅ¥ÎûòÏä§ */
        .hidden {
            display: none !important;
        }
        
        /* Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header-content {
                padding: 0 1rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .players-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .room-id-display {
                font-size: 2rem;
                letter-spacing: 0.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Ìó§Îçî -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <a href="/hub" class="back-button" title="ÌóàÎ∏åÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞">
                    <span>‚Üê</span>
                </a>
                <div class="room-title">
                    üè† Î£∏ ÎåÄÍ∏∞Ïã§
                </div>
            </div>
            <div class="connection-status">
                <div class="status-indicator" id="connectionStatus">
                    <div class="status-dot"></div>
                    <span id="connectionText">Ïó∞Í≤∞ Ï§ë...</span>
                </div>
                <div class="status-indicator" id="sensorStatus">
                    <div class="status-dot"></div>
                    <span id="sensorText">ÏÑºÏÑú ÎåÄÍ∏∞</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑà -->
    <div class="container">
        <!-- Î£∏ Ï†ïÎ≥¥ ÏÑπÏÖò -->
        <section class="room-info">
            <h2>üéÆ <span id="gameTitle">Í≤åÏûÑ Î£∏</span></h2>
            <div class="room-id-display" id="roomId">----</div>
            <div class="room-game-info" id="gameInfo">Í≤åÏûÑ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            <div class="room-state-badge" id="roomState">
                <span class="loading"></span>
                <span>ÎåÄÍ∏∞ Ï§ë</span>
            </div>
        </section>

        <!-- ÏÉÅÌÉú Î©îÏãúÏßÄ -->
        <div class="status-message hidden" id="statusMessage"></div>

        <!-- ÌîåÎ†àÏù¥Ïñ¥ Î™©Î°ù ÏÑπÏÖò -->
        <section class="players-section">
            <h3 class="section-title">
                üë• Ï∞∏Í∞ÄÏûê Î™©Î°ù 
                <span id="playerCount">(0/10)</span>
            </h3>
            <div class="players-grid" id="playersGrid">
                <!-- ÌîåÎ†àÏù¥Ïñ¥ Ïπ¥ÎìúÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
            </div>
        </section>

        <!-- Ïª®Ìä∏Î°§ ÏÑπÏÖò -->
        <section class="controls-section">
            <div class="button-group">
                <button class="btn btn-primary hidden" id="startGameBtn" disabled>
                    <span class="loading hidden" id="startGameLoading"></span>
                    <span id="startGameText">üéÆ Í≤åÏûÑ ÏãúÏûë</span>
                </button>
                <button class="btn btn-secondary" id="connectSensorBtn">
                    üì± ÏÑºÏÑú Ïó∞Í≤∞
                </button>
                <button class="btn btn-danger" id="leaveRoomBtn">
                    üö™ Î£∏ Îñ†ÎÇòÍ∏∞
                </button>
            </div>
        </section>
    </div>

    <!-- Î©îÏù∏ Ïä§ÌÅ¨Î¶ΩÌä∏ -->
    <script>
        /**
         * üè† Î£∏ ÎåÄÍ∏∞Ïã§ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏
         * 
         * Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Í≤åÏûÑÏùò ÌïµÏã¨ Í≤ΩÌóò
         */
        
        class RoomWaitingClient {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.roomId = null;
                this.sessionCode = null;
                this.sessionId = null;
                this.isHost = false;
                this.roomData = null;
                this.sensorConnected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                
                this.init();
            }
            
            /**
             * Ï¥àÍ∏∞Ìôî
             */
            init() {
                console.log('üè† Î£∏ ÎåÄÍ∏∞Ïã§ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî');
                
                // URLÏóêÏÑú Î£∏ ID Ï∂îÏ∂ú
                this.roomId = this.extractRoomIdFromURL();
                if (!this.roomId) {
                    this.showStatusMessage('ÏûòÎ™ªÎêú Î£∏ URLÏûÖÎãàÎã§', 'error');
                    return;
                }
                
                // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú ÏÑ∏ÏÖò Ï†ïÎ≥¥ ÌôïÏù∏
                const sessionData = this.getStoredSessionData();
                if (!sessionData) {
                    this.showStatusMessage('ÏÑ∏ÏÖò Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. ÌóàÎ∏åÎ°ú ÎèåÏïÑÍ∞ÄÏÑ∏Ïöî.', 'error');
                    return;
                }
                
                this.sessionCode = sessionData.sessionCode;
                this.sessionId = sessionData.sessionId;
                
                this.bindEvents();
                this.connect();
                this.updateRoomDisplay();
            }
            
            /**
             * URLÏóêÏÑú Î£∏ ID Ï∂îÏ∂ú
             */
            extractRoomIdFromURL() {
                const path = window.location.pathname;
                const matches = path.match(/\/room\/([A-Z0-9]+)/);
                return matches ? matches[1] : null;
            }
            
            /**
             * Ï†ÄÏû•Îêú ÏÑ∏ÏÖò Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
             */
            getStoredSessionData() {
                try {
                    const stored = localStorage.getItem('sgh_session');
                    if (!stored) return null;
                    
                    const data = JSON.parse(stored);
                    
                    // ÎßåÎ£å ÌôïÏù∏
                    if (data.expiresAt && Date.now() > data.expiresAt) {
                        localStorage.removeItem('sgh_session');
                        return null;
                    }
                    
                    return data;
                } catch (error) {
                    console.warn('‚ö†Ô∏è ÏÑ∏ÏÖò Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïã§Ìå®:', error);
                    return null;
                }
            }
            
            /**
             * Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
             */
            bindEvents() {
                // Í≤åÏûÑ ÏãúÏûë Î≤ÑÌäº
                document.getElementById('startGameBtn').addEventListener('click', () => {
                    this.startGame();
                });
                
                // ÏÑºÏÑú Ïó∞Í≤∞ Î≤ÑÌäº
                document.getElementById('connectSensorBtn').addEventListener('click', () => {
                    this.showSensorQR();
                });
                
                // Î£∏ Îñ†ÎÇòÍ∏∞ Î≤ÑÌäº
                document.getElementById('leaveRoomBtn').addEventListener('click', () => {
                    this.leaveRoom();
                });
                
                // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú Ï†ïÎ¶¨
                window.addEventListener('beforeunload', () => {
                    if (this.ws) {
                        this.ws.close();
                    }
                });
            }
            
            /**
             * WebSocket Ïó∞Í≤∞
             */
            connect() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}`;
                
                console.log(`üîó WebSocket Ïó∞Í≤∞ ÏãúÎèÑ: ${wsUrl}`);
                
                try {
                    this.ws = new WebSocket(wsUrl);
                    
                    this.ws.onopen = () => {
                        console.log('‚úÖ WebSocket Ïó∞Í≤∞ ÏÑ±Í≥µ');
                        this.isConnected = true;
                        this.reconnectAttempts = 0;
                        this.updateConnectionStatus(true);
                        
                        // Î£∏ ÏÉÅÌÉú ÏöîÏ≤≠
                        this.requestRoomStatus();
                    };
                    
                    this.ws.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            this.handleMessage(message);
                        } catch (error) {
                            console.error('‚ùå Î©îÏãúÏßÄ ÌååÏã± Ïò§Î•ò:', error);
                        }
                    };
                    
                    this.ws.onclose = () => {
                        console.log('üîå WebSocket Ïó∞Í≤∞ Ï¢ÖÎ£å');
                        this.isConnected = false;
                        this.updateConnectionStatus(false);
                        this.attemptReconnect();
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('‚ùå WebSocket Ïò§Î•ò:', error);
                        this.showStatusMessage('Ïó∞Í≤∞ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
                    };
                    
                } catch (error) {
                    console.error('‚ùå WebSocket Ïó∞Í≤∞ Ïã§Ìå®:', error);
                    this.showStatusMessage('ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§', 'error');
                }
            }
            
            /**
             * Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ
             */
            attemptReconnect() {
                if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                    this.showStatusMessage('ÏÑúÎ≤Ñ Ïó∞Í≤∞ÏùÑ Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                    return;
                }
                
                this.reconnectAttempts++;
                const delay = 2000 * Math.pow(2, this.reconnectAttempts - 1);
                
                console.log(`üîÑ Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ ${this.reconnectAttempts}/${this.maxReconnectAttempts} (${delay}ms ÌõÑ)`);
                this.showStatusMessage(`Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ Ï§ë... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`, 'warning');
                
                setTimeout(() => {
                    this.connect();
                }, delay);
            }
            
            /**
             * Î©îÏãúÏßÄ Ï†ÑÏÜ°
             */
            send(message) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify(message));
                    return true;
                }
                console.warn('‚ö†Ô∏è WebSocketÏù¥ Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏùå');
                return false;
            }
            
            /**
             * ÏÑúÎ≤Ñ Î©îÏãúÏßÄ Ï≤òÎ¶¨
             */
            handleMessage(message) {
                console.log('üì® Î©îÏãúÏßÄ ÏàòÏã†:', message.type);
                
                switch (message.type) {
                    case 'connected':
                        this.handleConnected(message);
                        break;
                    case 'room_joined':
                        this.handleRoomJoined(message);
                        break;
                    case 'player_joined':
                        this.handlePlayerJoined(message);
                        break;
                    case 'player_left':
                        this.handlePlayerLeft(message);
                        break;
                    case 'session_matched':
                        this.handleSensorConnected(message);
                        break;
                    case 'player_sensor_connected':
                        this.handlePlayerSensorConnected(message);
                        break;
                    case 'room_status_update':
                        this.handleRoomStatusUpdate(message);
                        break;
                    case 'game_started':
                        this.handleGameStarted(message);
                        break;
                    case 'navigate_to_game':
                        this.navigateToGame(message);
                        break;
                    case 'error':
                        this.handleError(message);
                        break;
                    default:
                        console.warn('‚ö†Ô∏è Ïïå Ïàò ÏóÜÎäî Î©îÏãúÏßÄ ÌÉÄÏûÖ:', message.type);
                }
            }
            
            /**
             * Ïó∞Í≤∞ ÌôïÏù∏ Ï≤òÎ¶¨
             */
            handleConnected(message) {
                console.log('‚úÖ ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÌôïÏù∏');
                this.showStatusMessage('ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§', 'success');
            }
            
            /**
             * Î£∏ Ï∞∏Í∞Ä ÏôÑÎ£å Ï≤òÎ¶¨
             */
            handleRoomJoined(message) {
                this.isHost = message.isHost;
                this.roomData = message.roomStatus;
                
                this.updateRoomData(this.roomData);
                this.showStatusMessage(`Î£∏Ïóê Ï∞∏Í∞ÄÌñàÏäµÎãàÎã§ (${this.isHost ? 'Ìò∏Ïä§Ìä∏' : 'Ï∞∏Í∞ÄÏûê'})`, 'success');
            }
            
            /**
             * ÏÉà ÌîåÎ†àÏù¥Ïñ¥ Ï∞∏Í∞Ä Ï≤òÎ¶¨
             */
            handlePlayerJoined(message) {
                this.roomData = message.roomStatus;
                this.updateRoomData(this.roomData);
                
                this.showStatusMessage(`${message.player.nickname}ÎãòÏù¥ Ï∞∏Í∞ÄÌñàÏäµÎãàÎã§`, 'info');
            }
            
            /**
             * ÌîåÎ†àÏù¥Ïñ¥ Ìá¥Ïû• Ï≤òÎ¶¨
             */
            handlePlayerLeft(message) {
                this.roomData = message.roomStatus;
                this.updateRoomData(this.roomData);
                
                this.showStatusMessage('ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Ìá¥Ïû•ÌñàÏäµÎãàÎã§', 'warning');
            }
            
            /**
             * ÏÑºÏÑú Ïó∞Í≤∞ Ï≤òÎ¶¨
             */
            handleSensorConnected(message) {
                this.sensorConnected = true;
                this.updateSensorStatus(true);
                this.showStatusMessage('ÏÑºÏÑúÍ∞Ä Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§!', 'success');
            }
            
            /**
             * ÌîåÎ†àÏù¥Ïñ¥ ÏÑºÏÑú Ïó∞Í≤∞ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
             */
            handlePlayerSensorConnected(message) {
                this.roomData = message.roomStatus;
                this.updateRoomData(this.roomData);
            }
            
            /**
             * Î£∏ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
             */
            handleRoomStatusUpdate(message) {
                this.roomData = message.roomStatus;
                this.updateRoomData(this.roomData);
            }
            
            /**
             * Í≤åÏûÑ ÏãúÏûë Ï≤òÎ¶¨
             */
            handleGameStarted(message) {
                this.showStatusMessage('Í≤åÏûÑÏù¥ ÏãúÏûëÎê©ÎãàÎã§!', 'success');
                
                // Í≤åÏûÑ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
                setTimeout(() => {
                    const gameUrl = `/games/${message.gameId}/index.html`;
                    window.location.href = gameUrl;
                }, 1000);
            }
            
            /**
             * Í≤åÏûÑ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
             */
            navigateToGame(message) {
                const gameUrl = `/games/${message.gameId}/index.html`;
                window.location.href = gameUrl;
            }
            
            /**
             * Ïò§Î•ò Ï≤òÎ¶¨
             */
            handleError(message) {
                console.error('‚ùå ÏÑúÎ≤Ñ Ïò§Î•ò:', message.error);
                this.showStatusMessage(message.error, 'error');
            }
            
            /**
             * Î£∏ ÏÉÅÌÉú ÏöîÏ≤≠
             */
            requestRoomStatus() {
                // Ïã§Ï†ú Íµ¨ÌòÑÏóêÏÑúÎäî ÏÑúÎ≤ÑÏóê Î£∏ ÏÉÅÌÉúÎ•º ÏöîÏ≤≠ÌïòÎäî Î©îÏãúÏßÄÎ•º Î≥¥ÎÉÑ
                // ÌòÑÏû¨Îäî ÏûÑÏãúÎ°ú Îπà Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
                console.log('üîç Î£∏ ÏÉÅÌÉú ÏöîÏ≤≠:', this.roomId);
            }
            
            /**
             * Î£∏ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
             */
            updateRoomDisplay() {
                document.getElementById('roomId').textContent = this.roomId || '----';
            }
            
            /**
             * Î£∏ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
             */
            updateRoomData(roomData) {
                if (!roomData) return;
                
                // Î£∏ Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                document.getElementById('roomId').textContent = roomData.roomId;
                document.getElementById('gameTitle').textContent = this.getGameTitle(roomData.gameId);
                document.getElementById('gameInfo').textContent = `${roomData.playerCount}/${roomData.maxPlayers} Î™Ö Ï∞∏Í∞Ä Ï§ë`;
                document.getElementById('playerCount').textContent = `(${roomData.playerCount}/${roomData.maxPlayers})`;
                
                // Î£∏ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                this.updateRoomState(roomData.state, roomData.canStart);
                
                // ÌîåÎ†àÏù¥Ïñ¥ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
                this.updatePlayersList(roomData.players);
                
                // Í≤åÏûÑ ÏãúÏûë Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏ (Ìò∏Ïä§Ìä∏Îßå)
                this.updateStartGameButton(roomData);
            }
            
            /**
             * Í≤åÏûÑ Ï†úÎ™© Í∞ÄÏ†∏Ïò§Í∏∞
             */
            getGameTitle(gameId) {
                const gameTitles = {
                    'multiplayer-sensor-test': 'Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ ÏÑºÏÑú ÌÖåÏä§Ìä∏',
                    'multiplayer-ball-game': 'Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥ Î≥º Í≤åÏûÑ'
                };
                return gameTitles[gameId] || gameId;
            }
            
            /**
             * Î£∏ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
             */
            updateRoomState(state, canStart) {
                const stateEl = document.getElementById('roomState');
                const stateTexts = {
                    'waiting': 'ÎåÄÍ∏∞ Ï§ë',
                    'ready': 'Ï§ÄÎπÑ ÏôÑÎ£å',
                    'starting': 'ÏãúÏûë Ï§ë',
                    'playing': 'Í≤åÏûÑ Ï§ë'
                };
                
                stateEl.innerHTML = '';
                
                if (state === 'ready' || canStart) {
                    stateEl.className = 'room-state-badge ready';
                    stateEl.innerHTML = '<span>‚úÖ</span><span>Ï§ÄÎπÑ ÏôÑÎ£å</span>';
                } else {
                    stateEl.className = 'room-state-badge';
                    stateEl.innerHTML = `<span>‚è≥</span><span>${stateTexts[state] || 'ÎåÄÍ∏∞ Ï§ë'}</span>`;
                }
            }
            
            /**
             * ÌîåÎ†àÏù¥Ïñ¥ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
             */
            updatePlayersList(players) {
                const grid = document.getElementById('playersGrid');
                grid.innerHTML = '';
                
                if (!players || players.length === 0) {
                    grid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-muted);">Ï∞∏Í∞ÄÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§</p>';
                    return;
                }
                
                players.forEach(player => {
                    const card = this.createPlayerCard(player);
                    grid.appendChild(card);
                });
            }
            
            /**
             * ÌîåÎ†àÏù¥Ïñ¥ Ïπ¥Îìú ÏÉùÏÑ±
             */
            createPlayerCard(player) {
                const card = document.createElement('div');
                card.className = 'player-card';
                
                if (player.isHost) {
                    card.classList.add('host');
                }
                
                if (player.sensorConnected) {
                    card.classList.add('ready');
                }
                
                card.innerHTML = `
                    <div class="player-header">
                        <div class="player-name">${player.nickname}</div>
                        ${player.isHost ? '<div class="host-badge">üëë Ìò∏Ïä§Ìä∏</div>' : ''}
                    </div>
                    <div class="sensor-status">
                        <div class="sensor-icon ${player.sensorConnected ? 'connected' : ''}"></div>
                        <div class="sensor-text ${player.sensorConnected ? 'connected' : ''}">
                            ${player.sensorConnected ? 'ÏÑºÏÑú Ïó∞Í≤∞Îê®' : 'ÏÑºÏÑú ÎåÄÍ∏∞ Ï§ë'}
                        </div>
                    </div>
                `;
                
                return card;
            }
            
            /**
             * Í≤åÏûÑ ÏãúÏûë Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏
             */
            updateStartGameButton(roomData) {
                const button = document.getElementById('startGameBtn');
                const text = document.getElementById('startGameText');
                
                if (this.isHost) {
                    button.classList.remove('hidden');
                    
                    if (roomData.canStart) {
                        button.disabled = false;
                        text.textContent = 'üéÆ Í≤åÏûÑ ÏãúÏûë';
                    } else {
                        button.disabled = true;
                        text.textContent = 'Î™®Îì† ÌîåÎ†àÏù¥Ïñ¥Ïùò ÏÑºÏÑú Ïó∞Í≤∞ ÎåÄÍ∏∞ Ï§ë...';
                    }
                } else {
                    button.classList.add('hidden');
                }
            }
            
            /**
             * Í≤åÏûÑ ÏãúÏûë
             */
            startGame() {
                if (!this.isHost) {
                    this.showStatusMessage('Ìò∏Ïä§Ìä∏Îßå Í≤åÏûÑÏùÑ ÏãúÏûëÌï† Ïàò ÏûàÏäµÎãàÎã§', 'error');
                    return;
                }
                
                const loading = document.getElementById('startGameLoading');
                const text = document.getElementById('startGameText');
                
                loading.classList.remove('hidden');
                text.textContent = 'Í≤åÏûÑ ÏãúÏûë Ï§ë...';
                
                this.send({
                    type: 'start_game'
                });
            }
            
            /**
             * ÏÑºÏÑú QR ÌëúÏãú
             */
            showSensorQR() {
                if (!this.sessionCode) {
                    this.showStatusMessage('ÏÑ∏ÏÖò Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§', 'error');
                    return;
                }
                
                const sensorUrl = `${window.location.origin}/sensor?code=${this.sessionCode}`;
                const message = `ÏÑºÏÑú Ïó∞Í≤∞ÏùÑ ÏúÑÌï¥ Î™®Î∞îÏùºÏóêÏÑú Îã§Ïùå URLÎ°ú Ï†ëÏÜçÌïòÏÑ∏Ïöî:\n\n${sensorUrl}\n\nÎòêÎäî ÏÑ∏ÏÖò ÏΩîÎìúÎ•º ÏßÅÏ†ë ÏûÖÎ†•ÌïòÏÑ∏Ïöî: ${this.sessionCode}`;
                
                alert(message);
            }
            
            /**
             * Î£∏ Îñ†ÎÇòÍ∏∞
             */
            leaveRoom() {
                if (confirm('Ï†ïÎßêÎ°ú Î£∏ÏùÑ Îñ†ÎÇòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    this.send({
                        type: 'leave_room'
                    });
                    
                    // ÌóàÎ∏åÎ°ú Ïù¥Îèô
                    window.location.href = '/hub';
                }
            }
            
            /**
             * Ïó∞Í≤∞ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
             */
            updateConnectionStatus(connected) {
                const statusEl = document.getElementById('connectionStatus');
                const textEl = document.getElementById('connectionText');
                
                if (connected) {
                    statusEl.classList.add('status-connected');
                    textEl.textContent = 'ÏÑúÎ≤Ñ Ïó∞Í≤∞Îê®';
                } else {
                    statusEl.classList.remove('status-connected');
                    textEl.textContent = 'Ïó∞Í≤∞ ÎÅäÏñ¥Ïßê';
                }
            }
            
            /**
             * ÏÑºÏÑú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
             */
            updateSensorStatus(connected) {
                const statusEl = document.getElementById('sensorStatus');
                const textEl = document.getElementById('sensorText');
                
                if (connected) {
                    statusEl.classList.add('status-connected');
                    textEl.textContent = 'ÏÑºÏÑú Ïó∞Í≤∞Îê®';
                } else {
                    statusEl.classList.remove('status-connected');
                    textEl.textContent = 'ÏÑºÏÑú ÎåÄÍ∏∞';
                }
            }
            
            /**
             * ÏÉÅÌÉú Î©îÏãúÏßÄ ÌëúÏãú
             */
            showStatusMessage(message, type = 'info') {
                const statusEl = document.getElementById('statusMessage');
                statusEl.textContent = message;
                statusEl.className = `status-message ${type}`;
                statusEl.classList.remove('hidden');
                
                // ÏûêÎèô Ïà®ÍπÄ (Ïò§Î•ò Î©îÏãúÏßÄ Ï†úÏô∏)
                if (type !== 'error') {
                    setTimeout(() => {
                        statusEl.classList.add('hidden');
                    }, 3000);
                }
            }
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', () => {
            window.roomWaitingClient = new RoomWaitingClient();
        });
    </script>
</body>
</html>